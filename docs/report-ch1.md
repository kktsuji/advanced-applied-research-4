\begin{center}
{\LARGE \textbf{特別応用研究Ⅳ - 空間周波数特性を考慮したデジタル画像フィルタ設計}}
\end{center}

\begin{flushright}
UNIVERSITY 工学専攻 COURSEコース LAB研究室\\
博士後期課程Y年 STUDENTNUMBER\\
NAME
\end{flushright}

---

## 1. デジタル画像処理の基礎

### 1.1 画像のデジタル表現

デジタル画像は、2次元平面上に配置された離散的な標本点の集合として表現される。各標本点は**画素（ピクセル、pixel）**と呼ばれ、画像を構成する最小の単位である。画素は2次元配列として表現され、画像 $I$ は次のように定義される：

$$
I[m, n] \quad (m = 0, 1, \ldots, M-1, \quad n = 0, 1, \ldots, N-1)
$$

ここで、$m$ と $n$ はそれぞれ画像の縦方向（行）と横方向（列）の位置を示すインデックスであり、$M \times N$ が画像の**解像度**（サイズ）を表す。

#### 画素値の意味

各画素 $I[m, n]$ が持つ数値を**画素値**と呼び、これは画像のその位置における明るさや色を表現する。グレースケール画像（輝度画像）の場合、画素値は明るさ（**輝度**）を表し、一般的に以下のような整数値で量子化される：

$$
I[m, n] \in \{0, 1, 2, \ldots, 2^b - 1\}
$$

ここで $b$ は**ビット深度**であり、8ビット画像の場合は $I[m, n] \in [0, 255]$ の範囲となる。画素値が大きいほど明るく、小さいほど暗いことを意味する。このように、連続的な明るさを離散的な階調レベルに分割することを**階調**と呼ぶ。8ビット画像では $2^8 = 256$ 階調の明るさを表現できる。

#### 画像の解像度とサイズ

画像の**解像度**は、画像を構成する画素の数を示す指標であり、通常は横方向×縦方向の画素数で表現される（例：$1920 \times 1080$, $640 \times 480$）。解像度が高いほど、より細かい詳細を表現できるが、その分データ量も増加する。

画像の**物理的なサイズ**は、画素数と画像を表示・印刷する際の**画素密度**（DPI: Dots Per Inch、または PPI: Pixels Per Inch）によって決まる。同じ解像度でも、画素密度が異なれば物理的なサイズは変わる。

### 1.2 カラー空間と輝度画像

#### カラー画像（RGB）の基本

カラー画像は、複数の色成分を組み合わせて色を表現する。最も一般的な表現方法は**RGB色空間**であり、赤（Red）、緑（Green）、青（Blue）の3つの原色の強度を組み合わせて様々な色を再現する。RGB画像は3つのチャンネル（色平面）から構成され、各画素は3つの画素値の組で表現される：

$$
I_{\text{RGB}}[m, n] = (R[m, n], G[m, n], B[m, n])
$$

ここで、$R[m, n]$, $G[m, n]$, $B[m, n]$ はそれぞれ赤、緑、青の成分を表す。8ビット画像の場合、各成分は $[0, 255]$ の範囲の値を取る。

#### グレイスケール画像の定義

カラー画像から**グレイスケール画像**（輝度画像）を得る最も一般的な方法は、RGB成分の加重平均を取る方法である：

$$
Y[m, n] = 0.299 \cdot R[m, n] + 0.587 \cdot G[m, n] + 0.114 \cdot B[m, n]
$$

この重み付けは、人間の視覚特性（緑に最も敏感で、青に最も鈍感）を反映したものである。この変換により、カラー画像の各画素 $(R, G, B)$ を単一の輝度値 $Y$ に変換し、8ビット画像の場合は $Y[m, n] \in [0, 255]$ の範囲のグレイスケール画像が得られる。

#### 本レポートでの扱い

本レポートでは、ノイズリダクション技術の原理と実装手法に焦点を当てるため、主に**グレイスケール画像**を用いて議論を進める。グレイスケール画像を扱うことで、色成分による複雑さを排除し、空間周波数特性やフィルタ設計の本質的な議論に集中できる。なお、カラー画像へのノイズリダクション適用は、各色成分（RGBの各チャンネル）に対して独立に処理を行うか、上記の加重平均によりグレイスケール画像に変換後に処理するなどの方法で実現可能である。

### 1.3 画像の空間周波数

#### 空間周波数の概念

**空間周波数**は、画像の空間的な変化の速さを表す概念である。時間領域の信号における時間周波数と同様に、画像においても空間的なパターンの周期性を周波数として表現できる。

1次元信号 $f(x)$ のフーリエ変換が周波数領域 $F(\omega)$ を与えるのと同様に、2次元画像 $I[m, n]$ に対しても2次元フーリエ変換を適用することで、空間周波数領域の表現 $I(\omega_x, \omega_y)$ が得られる：

$$
I(\omega_x, \omega_y) = \sum_{m=0}^{M-1} \sum_{n=0}^{N-1} I[m, n] \cdot e^{-j(\omega_x m + \omega_y n)}
$$

ここで、$\omega_x$ と $\omega_y$ はそれぞれ水平方向と垂直方向の空間周波数を表す。

#### 低周波成分と高周波成分の意味

画像の**低周波成分**は、空間的にゆっくりと変化する部分に対応する。具体的には、以下のような画像要素が低周波成分に含まれる：

- 広い領域にわたって滑らかに変化する明るさ
- 画像の大まかな形状や構造
- 平坦な背景領域

一方、**高周波成分**は、空間的に急激に変化する部分に対応する：

- エッジ（物体の輪郭や境界）
- 細かいテクスチャやディテール
- 急激な明るさの変化

数学的には、画像を低周波成分 $I_{\text{low}}$ と高周波成分 $I_{\text{high}}$ の和として分解できると考えることができる：

$$
I[m, n] = I_{\text{low}}[m, n] + I_{\text{high}}[m, n]
$$

#### ノイズリダクションと空間周波数の関係

多くの画像ノイズ、特にガウシアンノイズやセンサーノイズなどは、高周波成分を多く含む特性を持つ。これは、ノイズが画素間で急激に変化する傾向があるためである。

ノイズリダクションの基本的なアプローチの一つは、画像の高周波成分を減衰させることで、ノイズを低減する**ローパスフィルタ**を適用することである。ローパスフィルタは、低周波成分を通過させ、高周波成分を抑制する特性を持つ。

しかし、単純なローパスフィルタリングには課題がある。画像の重要な情報であるエッジやディテールも高周波成分に含まれるため、ノイズとともにこれらも減衰してしまい、画像がぼやけてしまう。この**ノイズ除去とエッジ保存のトレードオフ**が、ノイズリダクション技術における中心的な課題である。

周波数領域での考察は、効果的なノイズリダクションフィルタを設計する上で重要な指針を与える。次章では、具体的なノイズの周波数特性と、それに対応する各種フィルタリング手法について詳述する。

## 2. ノイズリダクション技術の概要

### 2.1 画像ノイズの種類と周波数特性

画像ノイズは、画像取得過程や信号処理過程で不可避的に混入する望ましくない信号成分である。ノイズリダクション技術を効果的に設計するためには、各種ノイズの特性、特に**空間領域での性質**と**周波数領域での性質**を理解することが不可欠である。本節では、代表的な画像ノイズの種類とその周波数特性について述べる。

#### ノイズの周波数領域における特性の概要

ノイズの性質を理解する上で、周波数領域での解析は重要な視点を与える。時間信号の周波数解析と同様に、画像ノイズも周波数スペクトルとして表現できる。一般に、ノイズは以下の観点から分類される：

- **周波数帯域の分布**：全周波数帯域に均等に分布する（ホワイトノイズ）か、特定周波数帯域に集中するか
- **空間的な相関**：画素間で独立か、空間的な相関を持つか
- **信号依存性**：画像の輝度値に依存するか、独立であるか
- **時間的特性**：フレーム間で固定か、時間的に変動するか

これらの特性により、効果的なノイズリダクション手法が異なってくる。

#### ガウシアンノイズ

**ガウシアンノイズ**（Gaussian noise）は、最も一般的な画像ノイズモデルである。元の画像信号に正規分布に従うランダムな変動が加算的に混入するノイズであり、デジタルカメラのセンサーノイズなどで頻繁に観測される。

**主要な特性**：

- 元の信号に加算される形で混入する
- 各画素のノイズは互いに独立（空間的な相関がない）
- 全周波数帯域に均等に分布する**ホワイトノイズ**特性を示す
- ローパスフィルタにより除去可能だが、画像のエッジやディテールも減衰してしまう

#### ショットノイズ（ポアソンノイズ）

**ショットノイズ**（shot noise）または**ポアソンノイズ**（Poisson noise）は、光子の量子的性質に起因するノイズであり、デジタルカメラやX線画像などの撮像システムで顕著に現れる。センサーに到達する光子数が確率的に変動することで発生する。

**主要な特性**：

- 全周波数帯域に広がる広帯域性を持つ
- ノイズの強度が信号の強度（明るさ）に依存する（明るい領域ほどノイズが大きい）
- 信号に対して乗算的な性質を持つため、適応的なフィルタリング手法が有効

#### 塩胡椒ノイズ（インパルスノイズ）

**塩胡椒ノイズ**（salt-and-pepper noise）または**インパルスノイズ**（impulse noise）は、画像の一部の画素が最大値（白、塩）または最小値（黒、胡椒）にランダムに置き換わるノイズである。センサーの不良画素、データ伝送エラー、アナログ-デジタル変換エラーなどによって発生する。

**主要な特性**：

- 画像の一部の画素にのみ影響する（スパース性）
- ノイズ値が最小値または最大値の極値を取る
- 空間的に急激な変化を与えるため、高周波成分が非常に大きくなる
- 線形フィルタよりも**メディアンフィルタ**のような非線形フィルタが効果的

#### センサー由来のノイズ

実際の撮像システムでは、センサーに起因する様々なノイズが存在する。

**固定パターンノイズ（Fixed Pattern Noise, FPN）**：
各画素のセンサー感度のばらつきやオフセット値の差異によって生じる、空間的に固定されたノイズパターン。主に低周波成分を含み、フレーム間で変化しない。事前にキャリブレーション画像を撮影し、それを用いて補正することが一般的である。

**熱ノイズ（Thermal Noise, Dark Current Noise）**：
センサー素子の熱的な電子の動きによって発生するランダムなノイズ。各画素で独立に発生し、ホワイトノイズ特性を示す。センサー温度の上昇とともにノイズが増加するため、センサーの冷却やローパスフィルタリングが有効である。

#### 周波数特性とフィルタリングの関係

各ノイズの周波数特性に応じた適切なフィルタリング戦略：

- **低周波ノイズ**（固定パターンノイズなど）：ハイパスフィルタリングまたはキャリブレーションベースの補正が有効
- **高周波ノイズ**（ガウシアンノイズ、ショットノイズなど）：ローパスフィルタリング、エッジ保存フィルタ、適応的フィルタリングが有効
- **広帯域ノイズ**（ホワイトノイズ）：多重解像度解析、ウェーブレット変換などが有効

ローパスフィルタの基本的な課題は、ノイズの高周波成分とともに画像の重要な高周波成分（エッジやテクスチャ）も減衰させてしまうことである。この課題を克服するために、次節で述べる**エッジ保存フィルタ**や**適応フィルタ**が開発されてきた。

### 2.2 代表的な空間フィルタとその周波数特性

空間フィルタは、画像の各画素に対してその近傍画素の値を用いた演算を行うことで、画像の特性を変化させる手法である。本節では、ノイズリダクションに用いられる代表的な空間フィルタについて、その数学的定義と周波数応答特性を詳述する。

#### ボックスフィルタ（平均化フィルタ）

**ボックスフィルタ**（box filter）または**平均化フィルタ**（averaging filter）は、最も単純なローパスフィルタであり、局所領域内の画素値の平均を出力する。

**フィルタカーネルの定義**：

ボックスフィルタのカーネル（フィルタ係数）は、全ての要素が等しい重みを持つ。例えば、3×3のボックスフィルタは、中心画素とその8近傍の計9画素の平均値を出力する。フィルタリング処理は、画像とカーネルの畳み込み演算として実行される。

**周波数応答特性**：

ボックスフィルタの周波数応答は、sinc関数の形状を持つ。ボックスフィルタの周波数特性には以下の特徴がある：

- **ローパス特性**：低周波成分を通過させ、高周波成分を減衰させる
- **sinc関数の形状**：低周波で最大値を持ち、周波数が増加するにつれて減衰
- **サイドローブの存在**：周波数軸上で正と負の値を繰り返すリップル（波打ち）が存在。これにより、一部の高周波成分が増幅される可能性がある
- **カットオフ周波数の急峻性が低い**：周波数遷移領域が広く、フィルタリングの選択性が低い

フィルタサイズが大きいほど、カットオフ周波数が低くなり、より強力なノイズ除去効果が得られるが、画像のぼけも大きくなる。

**利点と欠点**：

- **利点**：実装が極めて単純で、計算コストが低い
- **欠点**：
  - サイドローブによる周波数特性の劣化
  - エッジやディテールを大きくぼかしてしまう
  - すべての画素に等しい重みを与えるため、エッジ保存性がない

#### ガウシアンフィルタ

**ガウシアンフィルタ**（Gaussian filter）は、ガウス関数を重みとして用いるローパスフィルタである。ボックスフィルタよりも優れた周波数特性を持ち、画像処理で広く用いられている。

**フィルタカーネルの定義**：

1次元ガウスフィルタのカーネルは、ガウス分布（正規分布）に基づく：

$$
h[n] = \frac{1}{\sqrt{2\pi\sigma^2}} \exp\left(-\frac{n^2}{2\sigma^2}\right)
$$

2次元ガウスフィルタは、2次元ガウス分布を用いる：

$$
h[m, n] = \frac{1}{2\pi\sigma^2} \exp\left(-\frac{m^2 + n^2}{2\sigma^2}\right)
$$

ここで、$\sigma$ は**標準偏差**であり、ガウス分布の広がりを制御するパラメータである。$\sigma$ が大きいほど、フィルタの範囲が広がり、より強力な平滑化が行われる。

実際の実装では、連続的なガウス関数を離散化し、有限サイズのカーネルとして表現する。例えば、$\sigma = 1.0$ の場合の $5 \times 5$ ガウシアンカーネルは（正規化後）：

$$
h = \frac{1}{273} \begin{bmatrix}
1 & 4 & 7 & 4 & 1 \\
4 & 16 & 26 & 16 & 4 \\
7 & 26 & 41 & 26 & 7 \\
4 & 16 & 26 & 16 & 4 \\
1 & 4 & 7 & 4 & 1
\end{bmatrix}
$$

重要な性質として、2次元ガウス関数は**分離可能**（separable）である：

$$
h[m, n] = h_x[m] \cdot h_y[n]
$$

これにより、2次元畳み込みを2つの1次元畳み込みで実現でき、計算コストを大幅に削減できる（$O(N^2)$ から $O(2N)$ へ）。

**周波数応答特性**：

ガウシアンフィルタの重要な性質は、**周波数領域でもガウス関数の形状を保つ**ことである（ガウス関数のフーリエ変換はガウス関数）：

$$
H(\omega) = \exp\left(-\frac{\sigma^2 \omega^2}{2}\right)
$$

この周波数応答は以下の優れた特性を持つ：

- **滑らかなロールオフ特性**：周パスから阻止域への遷移が滑らか
- **サイドローブが存在しない**：ボックスフィルタと異なり、周波数応答は単調減少し、リップルがない
- **最小の時間周波数の不確定性**：ガウス関数は、空間領域と周波数領域の両方で最も局在化された関数（不確定性原理において最適）
- **全ての周波数成分が正**：負の周波数応答を持たないため、不自然なアーティファクトが生じにくい

標準偏差 $\sigma$ とカットオフ周波数の関係：

カットオフ周波数（-3dB点、すなわち $|H(\omega)| = 1/\sqrt{2}$ となる周波数）は次のように求められる：

$$
\exp\left(-\frac{\sigma^2 \omega_c^2}{2}\right) = \frac{1}{\sqrt{2}}
$$

これを解くと：

$$
\omega_c = \sqrt{\frac{2\ln 2}{\sigma^2}} \approx \frac{1.18}{\sigma}
$$

つまり、$\sigma$ を大きくすると、カットオフ周波数は低くなり、より強力なローパスフィルタとなる。

**利点と欠点**：

- **利点**：
  - 優れた周波数特性（サイドローブなし）
  - 分離可能性による効率的な実装
  - 理論的に最適な局在化特性
  - パラメータ $\sigma$ でフィルタ強度を直感的に制御可能

- **欠点**：
  - ボックスフィルタよりも計算コストが高い（ただし分離可能性により軽減）
  - 依然としてエッジをぼかしてしまう（均一な重み付けのため）

#### イプシロンフィルタ（エッジ保存フィルタ）

**イプシロンフィルタ**（epsilon filter）は、画素値の差に基づいて適応的に重みを調整する**エッジ保存フィルタ**（edge-preserving filter）の一種である。このフィルタは、エッジ部分では平滑化を抑制し、平坦部分では強力な平滑化を行うことで、ノイズ除去とエッジ保存を両立させる。

**フィルタの原理**：

イプシロンフィルタは、中心画素 $I[m, n]$ と近傍画素 $I[i, j]$ の輝度差に基づいて重みを計算する。輝度差が小さい（同質な領域）画素には大きな重みを与え、輝度差が大きい（エッジを跨ぐ）画素には小さな重みを与える。

**数式表現**：

重み関数 $w$ は、画素値の差 $x = I[i, j] - I[m, n]$ に対して定義される：

$$
w(x) = \frac{1}{1 + \left(\frac{|x|}{\epsilon}\right)^2}
$$

ここで、$\epsilon$ は**閾値パラメータ**であり、どの程度の輝度差をエッジとみなすかを制御する。$\epsilon$ が小さいほど、小さな輝度差もエッジとして扱われ、エッジ保存性が強くなる。

フィルタリング後の出力は、重み付き平均として計算される：

$$
I_{\text{filtered}}[m, n] = \frac{\sum_{(i,j) \in \mathcal{N}(m,n)} w(I[i, j] - I[m, n]) \cdot I[i, j]}{\sum_{(i,j) \in \mathcal{N}(m,n)} w(I[i, j] - I[m, n])}
$$

ここで、$\mathcal{N}(m, n)$ は中心画素 $(m, n)$ の近傍領域（例：$3 \times 3$ または $5 \times 5$）を表す。

**重み関数の挙動**：

- **輝度差が小さい場合**（$|x| \ll \epsilon$）：$w(x) \approx 1$。近傍画素は中心画素と同じ物体に属すると判断され、大きな重みが与えられる
- **輝度差が大きい場合**（$|x| \gg \epsilon$）：$w(x) \approx 0$。近傍画素は別の物体（エッジの向こう側）に属すると判断され、ほとんど重みが与えられない
- **中間的な輝度差**：重みは滑らかに変化

**周波数応答特性**：

イプシロンフィルタは**非線形フィルタ**であるため、周波数応答は入力信号に依存し、線形フィルタのように単一の周波数伝達関数では表現できない。しかし、局所的な挙動を以下のように理解できる：

**エッジ部分での高周波保存特性**：

- エッジ領域では、エッジを跨ぐ画素の重みが小さくなるため、エッジの急激な輝度変化（高周波成分）が保存される
- これは、エッジ方向に対して異方性のフィルタ特性を持つことを意味する
- エッジに垂直な方向では高周波成分を保持し、エッジに平行な方向ではローパス特性を示す

**平坦部でのローパス特性**：

- 平坦な領域では、近傍画素の輝度差が小さいため、ほぼ全ての近傍画素に大きな重みが与えられる
- この場合、ボックスフィルタに近い動作となり、ローパス特性を示す
- ノイズの高周波成分が効果的に除去される

**εパラメータと周波数特性の関係**：

- **$\epsilon$ が小さい場合**：小さな輝度差もエッジとみなされ、フィルタリングが抑制される。結果として、高周波成分の保存性が高くなるが、ノイズ除去効果は弱くなる
- **$\epsilon$ が大きい場合**：大きな輝度差でもエッジとみなされにくく、より強力な平滑化が行われる。ノイズ除去効果は高いが、エッジもぼやける可能性がある

適切な $\epsilon$ の値は、画像のコントラストとノイズレベルに依存する。一般的には、ノイズの標準偏差の2〜3倍程度が経験的によく用いられる。

**バイラテラルフィルタとの関係**：

イプシロンフィルタは、より一般的な**バイラテラルフィルタ**（bilateral filter）の特殊な形と見なせる。バイラテラルフィルタは、空間距離と輝度差の両方を考慮して重みを計算する：

$$
w(i, j, m, n) = \exp\left(-\frac{(i-m)^2 + (j-n)^2}{2\sigma_s^2}\right) \cdot \exp\left(-\frac{(I[i,j] - I[m,n])^2}{2\sigma_r^2}\right)
$$

ここで、$\sigma_s$ は空間的な重みの広がり、$\sigma_r$ は輝度差に対する感度を制御する。イプシロンフィルタは、空間的な重みが均一（または固定サイズの近傍領域内で一定）で、輝度差の重み関数が異なる形式を持つと考えられる。

**利点と欠点**：

- **利点**：
  - エッジ保存性が高く、ノイズ除去とディテール保持を両立
  - パラメータ $\epsilon$ でエッジ保存とノイズ除去のバランスを調整可能
  - 単純な重み関数により、実装が比較的容易

- **欠点**：
  - 非線形フィルタであるため、線形フィルタよりも計算コストが高い
  - 各画素で重みを動的に計算する必要がある
  - 最適な $\epsilon$ の値は画像やノイズレベルに依存し、自動決定が難しい
  - ハードウェア実装では、重み計算のための除算や累乗演算が必要

#### フィルタ比較

上記3つのフィルタの特性を比較する：

| 特性               | ボックスフィルタ             | ガウシアンフィルタ   | イプシロンフィルタ         |
| ------------------ | ---------------------------- | -------------------- | -------------------------- |
| **種類**           | 線形                         | 線形                 | 非線形                     |
| **周波数応答**     | sinc関数（サイドローブあり） | ガウス関数（滑らか） | 信号依存（局所適応）       |
| **エッジ保存性**   | 低い                         | 低い                 | 高い                       |
| **ノイズ除去性能** | 中程度                       | 高い                 | 高い（エッジを保持しつつ） |
| **計算コスト**     | 低い                         | 中程度（分離可能）   | 高い（適応的重み計算）     |
| **実装の容易さ**   | 非常に容易                   | 容易                 | 中程度                     |
| **パラメータ**     | カーネルサイズ               | $\sigma$（標準偏差） | $\epsilon$（輝度差閾値）   |
| **主な用途**       | 高速な平滑化                 | 汎用的なノイズ除去   | エッジ保存ノイズ除去       |

**ノイズ除去性能とエッジ保存のトレードオフ**：

- **ボックスフィルタとガウシアンフィルタ**は、線形フィルタとして全ての画素に対して一様な処理を行うため、ノイズとともにエッジもぼかしてしまう。フィルタサイズや $\sigma$ を大きくするほどノイズ除去効果は高まるが、エッジの劣化も激しくなる

- **イプシロンフィルタ**のような非線形エッジ保存フィルタは、画像の局所的な構造（エッジかどうか）に適応することで、このトレードオフを改善する。エッジ部分では平滑化を抑制し、平坦部分では強力に平滑化することで、ノイズ除去とエッジ保存を両立させる

実際の応用では、目的に応じてフィルタを選択する：

- **高速処理が必要**な場合：ボックスフィルタ
- **汎用的なノイズ除去**が目的の場合：ガウシアンフィルタ
- **エッジやディテールの保存が重要**な場合：イプシロンフィルタやバイラテラルフィルタ

ハードウェア実装の観点からは、ボックスフィルタとガウシアンフィルタは線形演算のみで構成されるため実装が容易であるが、イプシロンフィルタは重みの動的計算が必要であり、実装の複雑さが増す。この課題に対処するために、本レポートの提案手法では、ハードウェア実装制約を考慮した工夫を行う（第4章で詳述）。

### 2.3 ノイズリダクション手法の分類と概要

本節では、ノイズリダクション手法を処理アプローチに基づいて分類し、各手法の概要と特にハードウェア実装の観点からの特性について述べる。

#### 空間フィルタリング手法の概要

**空間フィルタリング**（spatial filtering）は、画像の空間領域で直接演算を行う手法であり、各画素の近傍領域の情報を用いて出力画素値を計算する。

**線形フィルタ**：

前節で述べたボックスフィルタやガウシアンフィルタは、線形フィルタの代表例である。線形フィルタは、畳み込み演算として表現されるため、数学的な解析が容易であり、実装も比較的単純である。

主な線形フィルタ：

- **平均化フィルタ**：局所領域の平均値を出力
- **ガウシアンフィルタ**：ガウス分布に基づく重み付き平均
- **ウィーナーフィルタ**：信号とノイズの統計的性質に基づく最適線形フィルタ（後述）

**非線形フィルタ**：

非線形フィルタは、線形演算では表現できない処理を行うことで、線形フィルタでは実現困難なエッジ保存性やインパルスノイズ除去性能を実現する。

主な非線形フィルタ：

- **メディアンフィルタ**：局所領域の画素値の中央値を出力。塩胡椒ノイズに対して特に効果的
- **エッジ保存フィルタ**：イプシロンフィルタ、バイラテラルフィルタなど。輝度差に基づいて適応的に重みを調整
- **モルフォロジカルフィルタ**：膨張・収縮などの形態学的演算を用いたフィルタ

**ハードウェア実装の観点からの課題**：

空間フィルタリング手法は、局所的な演算のため、比較的ハードウェア実装に適している。しかし以下の課題が存在する：

1. **大きなフィルタカーネルの問題**：
   - カーネルサイズが $N \times N$ の場合、2次元畳み込みには $N^2$ 回の乗算と加算が必要
   - メモリアクセスも $N^2$ 回必要であり、メモリ帯域が問題となる
   - ラインバッファ方式では、$N$ 行分のラインバッファが必要（例：$7 \times 7$ フィルタには7行分）

2. **非線形フィルタの複雑さ**：
   - イプシロンフィルタのような非線形フィルタは、各画素で動的に重みを計算する必要がある
   - 除算、平方根、累乗などの複雑な演算が必要で、ハードウェアリソースが増大
   - メディアンフィルタはソート処理が必要で、並列化が困難

3. **リアルタイム処理の制約**：
   - 高解像度画像（例：4K, 8K）では、フレームレート（30fps, 60fps）を維持するために、極めて高いスループットが要求される
   - パイプライン処理によるレイテンシの増加も考慮が必要

これらの課題に対処するため、**小サイズカーネルの使用**、**分離可能フィルタの活用**、**近似演算の導入**、**専用ハードウェアアクセラレータの設計**などの工夫が行われる。本レポートの提案手法では、多重解像度アプローチと小サイズフィルタを組み合わせることで、これらの制約に対応する。

#### 周波数領域フィルタリング手法の概要

**周波数領域フィルタリング**（frequency domain filtering）は、画像をフーリエ変換やウェーブレット変換などによって周波数領域に変換し、周波数成分に対して直接フィルタリングを行う手法である。

**フーリエ変換ベース**：

画像全体に2次元離散フーリエ変換（DFT）または高速フーリエ変換（FFT）を適用し、周波数スペクトルを得る。その後、周波数領域でフィルタ（理想ローパスフィルタ、バターワースフィルタなど）を適用し、逆フーリエ変換によって空間領域に戻す。

処理手順：

1. 画像 $I[m, n]$ にFFTを適用して $I(\omega_x, \omega_y)$ を得る
2. 周波数フィルタ $H(\omega_x, \omega_y)$ を乗算：$I'(\omega_x, \omega_y) = I(\omega_x, \omega_y) \cdot H(\omega_x, \omega_y)$
3. 逆FFTを適用して $I'[m, n]$ を得る

利点：

- 周波数特性を直接制御できる
- 大きなカーネルの畳み込みをFFTの乗算で効率的に実現（FFTの計算量は $O(N^2 \log N)$）

**ウェーブレット変換ベース**：

ウェーブレット変換は、画像を複数の解像度レベルと方向成分に分解する。各サブバンド（周波数・方向成分）に対して、適応的にノイズ除去処理（例：閾値処理、縮退）を行う。

代表的な手法：

- **ウェーブレット閾値処理**：小さい係数（ノイズ）を閾値以下で0に設定し、大きい係数（信号）を保持
- **ウェーブレット縮退**（shrinkage）：係数を適応的に縮小

利点：

- 周波数と空間の両方で局在化された解析が可能
- 多重解像度表現により、スケールに応じたノイズ除去が可能
- エッジやディテールの保存性が高い

**ハードウェア実装の観点からの課題**：

周波数領域フィルタリング手法は、以下の理由からハードウェア実装において大きな制約がある：

1. **全画像バッファが必要**：
   - FFTやウェーブレット変換は、画像全体（または大きなブロック）を同時にメモリに保持する必要がある
   - 高解像度画像では、膨大なフレームバッファが必要（例：4K画像で約8MB）
   - リアルタイム処理では、フレーム全体が到着するまで処理を開始できず、レイテンシが大きい

2. **計算量の問題**：
   - FFTは効率的なアルゴリズムであるが、それでも画像全体に対する変換は計算コストが高い
   - ウェーブレット変換も、複数レベルの分解と再構成が必要

3. **ラインバッファ方式との不整合**：
   - 組み込み画像処理システムでは、**ラインバッファ方式**（1行ずつ処理）が一般的
   - 周波数領域フィルタは、この方式と本質的に相性が悪い

このため、周波数領域フィルタリングは、主にオフライン処理や、十分なメモリと計算リソースを持つシステム（PC、GPU）で用いられる。ハードウェア実装が必要なリアルタイム組み込みシステムでは、空間フィルタリングが選択されることが多い。

#### 適応フィルタリング手法の概要

**適応フィルタリング**（adaptive filtering）は、画像の局所的な特性やノイズの統計的性質に基づいて、フィルタのパラメータや処理方法を動的に調整する手法である。これにより、画像の異なる領域に対して最適な処理を行うことができる。

**ウィナーフィルタ（Wiener Filter）**：

ウィナーフィルタは、信号とノイズのパワースペクトルに基づいて、平均二乗誤差を最小化する最適線形フィルタである。局所的な分散を推定し、それに基づいてフィルタ係数を調整する。

周波数領域でのウィナーフィルタは次のように表される：

$$
H(\omega_x, \omega_y) = \frac{|I(\omega_x, \omega_y)|^2}{|I(\omega_x, \omega_y)|^2 + |\eta(\omega_x, \omega_y)|^2}
$$

ここで、$|I(\omega_x, \omega_y)|^2$ は信号のパワースペクトル、$|\eta(\omega_x, \omega_y)|^2$ はノイズのパワースペクトルである。

空間領域での適応ウィナーフィルタは、局所的な平均と分散を用いて実現される。

**非局所平均（Non-Local Means, NLM）**：

非局所平均は、画像全体から類似したパッチ（小領域）を探索し、それらの加重平均を取る手法である。従来の空間フィルタが局所近傍のみを使用するのに対し、NLMは画像全体の構造的類似性を活用する。

$$
I_{\text{NLM}}[m, n] = \frac{1}{Z} \sum_{(i,j)} w(m, n, i, j) \cdot I[i, j]
$$

ここで、重み $w(m, n, i, j)$ は、画素 $(m, n)$ 周辺のパッチと画素 $(i, j)$ 周辺のパッチの類似度に基づいて計算される。

**BM3D（Block-Matching and 3D Filtering）**：

BM3Dは、類似したブロックをグループ化し、3次元（2次元空間 + 類似ブロック軸）の協調フィルタリングを行う高性能なノイズ除去手法である。現在、最も高性能なノイズ除去アルゴリズムの一つとされている。

処理手順：

1. 類似ブロックの探索とグループ化
2. 3次元変換（2D変換 + 1D変換）
3. 閾値処理またはウィナーフィルタリング
4. 逆変換と統合

**ハードウェア実装の観点からの課題**：

適応フィルタリング手法は、極めて高いノイズ除去性能を持つが、ハードウェア実装において深刻な課題がある：

1. **計算量の膨大さ**：
   - NLMやBM3Dは、広範囲のパッチ探索が必要で、計算量が非常に大きい
   - BM3Dの計算量は、単純な空間フィルタの数百〜数千倍に達する

2. **メモリアクセスの複雑さ**：
   - 非局所的なメモリアクセスが頻繁に発生し、メモリ帯域が律速となる
   - ランダムアクセスが多く、キャッシュ効率が低い

3. **アルゴリズムの複雑さ**：
   - ブロックマッチング、類似度計算、複数回の変換など、複雑なステップが多い
   - ハードウェアでの実装には、専用のアクセラレータ設計が必要

4. **リアルタイム処理の困難さ**：
   - 上記の理由により、リアルタイム処理は非常に困難
   - GPUを用いた並列処理でも、高解像度画像のリアルタイム処理は挑戦的

このため、これらの高性能手法は、主にオフライン処理や計算リソースが豊富な環境で使用される。組み込みシステムやリアルタイム処理が必要なハードウェア実装では、より単純な空間フィルタリング手法が現実的な選択肢となる。

#### ハードウェア実装制約を考慮した手法選択

以下の表に、各手法の特性とハードウェア実装適性をまとめる：

| 手法分類                   | 代表的手法                           | ノイズ除去性能 | 計算量 | メモリ量           | HW実装適性   |
| -------------------------- | ------------------------------------ | -------------- | ------ | ------------------ | ------------ |
| **空間フィルタ（線形）**   | ボックス、ガウシアン                 | 中             | 低〜中 | 低（ライン単位）   | ◎ 高い       |
| **空間フィルタ（非線形）** | メディアン、イプシロン、バイラテラル | 中〜高         | 中〜高 | 低（ライン単位）   | ○ 中程度     |
| **周波数領域フィルタ**     | FFT、ウェーブレット                  | 中〜高         | 高     | 高（フレーム単位） | △ 低い       |
| **適応フィルタ**           | ウィナー、NLM、BM3D                  | 高〜極高       | 極高   | 高（フレーム単位） | × 極めて低い |

本レポートで提案する手法は、**空間フィルタリング**のアプローチを基本としつつ、**多重解像度処理**と**小サイズフィルタ**を組み合わせることで、ハードウェア実装制約の下で効果的なノイズリダクションを実現することを目指す。具体的には：

- **ラインバッファ方式に適合**：各解像度レベルで小サイズフィルタを使用することで、必要なラインバッファ数を削減
- **線形演算中心**：基本的には線形フィルタを使用し、ハードウェア実装を容易化
- **IIRフィルタの活用**：縦方向処理にIIRフィルタを導入し、メモリ使用量をさらに削減
- **簡易的なエッジ保存機構**：ラインバッファ上で実現可能な簡易方向検出フィルタにより、エッジ保存性を向上

これらの工夫により、実務で使用されるハードウェア制約の下でも実装可能で、かつ十分なノイズ除去性能を持つ手法を実現する。次章では、ハードウェア実装制約について詳述し、それらが画像処理アルゴリズムに与える影響を分析する。
