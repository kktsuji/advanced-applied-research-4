## 3. ハードウェア実装制約とその影響

前章では、ノイズリダクション技術の理論的な基礎と、各種フィルタの周波数特性について詳述した。しかし、これらの手法を実際のシステムに組み込む際には、ハードウェア実装における様々な制約を考慮する必要がある。本章では、実装環境における計算リソース、処理速度、メモリ容量などの制約条件を明確化し、従来手法がこれらの制約下で直面する課題を分析する。

### 3.1 計算リソースの制限

デジタル画像処理をハードウェアで実装する際、最も重要な制約の一つが計算リソースの制限である。特に、組み込みシステムやFPGA（Field-Programmable Gate Array）などの専用ハードウェアでは、利用可能なメモリ容量や演算器の数量に厳しい制限がある。

#### メモリ容量の制約

画像処理における最大の実装課題の一つは、処理に必要なメモリ容量の確保である。高解像度画像を扱う場合、画像全体を保持するために必要なメモリ量は膨大になる。

##### フレームバッファとラインバッファ

画像処理アルゴリズムをハードウェア実装する際、メモリアーキテクチャとして以下の2つの方式が考えられる。

**フレームバッファ方式**は、画像全体を一度にメモリに格納する方式である。解像度が $M \times N$ の画像を処理する場合、必要なメモリ容量は：

$$
\text{Memory}_{\text{frame}} = M \times N \times b \quad [\text{bits}]
$$

ここで、$b$ は1画素あたりのビット深度である。例えば、フルHD画像（$1920 \times 1080$ 画素）を8ビットグレースケールで扱う場合：

$$
\text{Memory}_{\text{frame}} = 1920 \times 1080 \times 8 = 16,588,800 \text{ bits} \approx 2.07 \text{ MB}
$$

さらに、入力画像と出力画像を同時に保持する場合、この2倍のメモリが必要となる。4K画像（$3840 \times 2160$）では約8.3 MBとなり、組み込みシステムのオンチップメモリとしては非常に大きな容量である。

一方、**ラインバッファ方式**は、画像を1行ずつ処理するストリーミング処理方式である。この方式では、画像全体を保持する必要がなく、フィルタリングに必要な最小限の行数のみをメモリに保持すれば良い。$K \times K$ サイズのフィルタを適用する場合、必要なラインバッファ数は $K$ 行であり、メモリ容量は：

$$
\text{Memory}_{\text{line}} = K \times N \times b \quad [\text{bits}]
$$

例えば、$5 \times 5$ のフィルタをフルHD画像に適用する場合：

$$
\text{Memory}_{\text{line}} = 5 \times 1920 \times 8 = 76,800 \text{ bits} \approx 9.6 \text{ KB}
$$

フレームバッファと比較すると、**約215分の1**のメモリで済むことがわかる。

##### メモリ容量とフィルタサイズの関係

ラインバッファ方式の利点は明白であるが、フィルタサイズが大きくなると必要なラインバッファ数も増加する。フィルタサイズ $K$ と必要メモリは線形関係にあるため、$K$ が2倍になればメモリ容量も2倍必要となる：

| フィルタサイズ $K$ | ラインバッファ数 | 必要メモリ（フルHD） |
|:---:|:---:|:---:|
| 3 | 3 | 約 5.8 KB |
| 5 | 5 | 約 9.6 KB |
| 7 | 7 | 約 13.4 KB |
| 11 | 11 | 約 21.1 KB |
| 15 | 15 | 約 28.8 KB |

このため、ハードウェア実装においては、**小さなフィルタサイズを用いることが強く推奨される**。しかし、小さなフィルタでは十分なノイズ低減効果が得られない場合があり、これが後述する提案手法における重要な課題となる。

#### 演算器のリソース制約

ハードウェア実装、特にFPGAなどのプログラマブルデバイスでは、利用可能な演算器の数量も大きな制約となる。

##### 乗算器と加算器の数量制限

畳み込み演算は、大量の乗算と加算を必要とする。$K \times K$ サイズのフィルタによる畳み込み演算は、1画素あたり $K^2$ 回の乗算と $K^2 - 1$ 回の加算を要する：

$$
y[m, n] = \sum_{i=0}^{K-1} \sum_{j=0}^{K-1} h[i, j] \cdot x[m-i, n-j]
$$

例えば、$5 \times 5$ のフィルタでは、1画素あたり25回の乗算と24回の加算が必要である。フルHD画像（約207万画素）を処理する場合、合計で：

- 乗算回数：$1920 \times 1080 \times 25 = 51,840,000$ 回
- 加算回数：$1920 \times 1080 \times 24 = 49,766,400$ 回

リアルタイム処理（30 fps）を実現するには、1秒あたり約15億回の乗算が必要となる。

FPGAにおいて、乗算器は比較的リソースを消費する演算要素である。例えば、一般的なFPGAでは、18ビット×18ビットの乗算器（DSPブロック）が数百個程度搭載されている。全ての演算を並列化することは不可能であり、演算器の再利用やパイプライン化が必要となる。

##### ビット幅の制約

ハードウェア実装では、演算のビット幅も重要な考慮事項である。画像データが8ビットの場合でも、乗算や累積加算により中間結果のビット幅は増加する。$K \times K$ のフィルタによる畳み込みでは、最悪の場合、出力ビット幅は：

$$
b_{\text{out}} = b_{\text{in}} + b_{\text{coeff}} + \lceil \log_2(K^2) \rceil
$$

ここで、$b_{\text{in}}$ は入力画像のビット幅、$b_{\text{coeff}}$ はフィルタ係数のビット幅である。例えば、8ビット入力、8ビット係数、$5 \times 5$ フィルタの場合：

$$
b_{\text{out}} = 8 + 8 + \lceil \log_2(25) \rceil = 8 + 8 + 5 = 21 \text{ bits}
$$

ビット幅の増加は、演算器のサイズ増大だけでなく、配線リソースや消費電力にも影響する。そのため、適切なビット幅管理と固定小数点演算の最適化が必要となる。

#### 並列処理の限界

画像処理の高速化手法として並列処理が有効であるが、ハードウェアリソースの制約により並列度には限界がある。

##### 空間的並列処理

理想的には、画像の複数の画素を同時に処理することで、スループットを向上できる。しかし、並列度を $P$ 倍にすると、必要な演算器の数も $P$ 倍になる。前述の通り、FPGAの演算リソースは有限であるため、無制限に並列度を上げることはできない。

さらに、ラインバッファからのデータ読み出しにも制約がある。$P$ 画素を並列処理する場合、メモリバンド幅も $P$ 倍必要となる。メモリアクセスのボトルネックにより、演算器を増やしても性能が向上しないケースもある。

##### パイプライン並列処理

パイプライン処理は、処理を複数のステージに分割し、各ステージが異なるデータを同時に処理する手法である。これにより、スループットを向上できるが、以下の制約がある：

- **レイテンシの増加**：パイプラインのステージ数が増えるほど、最初のデータが出力されるまでの時間（レイテンシ）が長くなる。
- **バッファの必要性**：ステージ間でデータを保持するためのバッファが必要であり、メモリ容量を消費する。
- **制御の複雑化**：パイプラインのストールやフラッシュなど、制御ロジックが複雑になる。

### 3.2 処理速度の制約

画像処理システム、特にリアルタイム処理を要求されるシステムでは、処理速度に関する厳しい制約が存在する。

#### リアルタイム処理の必要性

多くの画像処理アプリケーション、例えば以下のような用途では、リアルタイム処理が必須要件となる：

- **ビデオ撮影・配信システム**：カメラからの映像をリアルタイムで処理し、ノイズを除去して表示・記録する。
- **医療画像診断装置**：X線撮影、内視鏡、超音波画像などをリアルタイムで表示し、診断を支援する。
- **自動車向けカメラシステム**：ドライブレコーダー、バックカメラ、ADAS（先進運転支援システム）などで、遅延のない映像表示が安全性のために重要。
- **産業用検査装置**：製造ラインでの欠陥検出など、高速処理が生産性に直結する。

これらの用途では、処理遅延が大きいとシステムとして使用できない。例えば、自動車のバックカメラで1秒の遅延があれば、事故の危険性が高まる。

#### フレームレート要件

ビデオ処理において、フレームレートは重要な性能指標である。一般的なフレームレートと、その要求される処理時間は以下の通りである：

| フレームレート | 1フレームの処理時間 | 用途例 |
|:---:|:---:|:---|
| 30 fps | 33.3 ms | 一般的なビデオ撮影、監視カメラ |
| 60 fps | 16.7 ms | 高品質映像、ゲーム、医療機器 |
| 120 fps | 8.3 ms | スローモーション撮影、高速現象の観測 |
| 240 fps | 4.2 ms | 超高速撮影、スポーツ解析 |

フルHD画像（$1920 \times 1080 = 2,073,600$ 画素）を30 fpsで処理する場合、1秒あたり約6220万画素を処理する必要がある。1画素あたりに許される処理時間は：

$$
T_{\text{pixel}} = \frac{1}{1920 \times 1080 \times 30} \approx 16.1 \text{ ns}
$$

システムクロックが100 MHzの場合、1画素あたりに使える**クロックサイクル数はわずか1.6サイクル**となる。これは、非常に効率的な処理アーキテクチャが必要であることを意味する。

#### レイテンシの制約

**スループット**（単位時間あたりの処理画素数）と**レイテンシ**（処理開始から結果出力までの時間）は、どちらも重要な性能指標であるが、異なる概念である。

ラインバッファを用いたストリーミング処理では、画像全体のレイテンシは：

$$
L = T_{\text{line}} \times K + T_{\text{proc}}
$$

ここで、$T_{\text{line}}$ は1ラインの読み込み時間、$K$ はフィルタサイズ（必要ラインバッファ数）、$T_{\text{proc}}$ は処理自体の遅延である。

例えば、フルHDで30 fps、$5 \times 5$ フィルタの場合：
- 1ラインの時間：$\frac{33.3 \text{ ms}}{1080} \approx 30.8 \mu\text{s}$
- ラインバッファによるレイテンシ：$30.8 \mu\text{s} \times 5 = 154 \mu\text{s}$

これに処理遅延やパイプライン遅延が加わる。多くのアプリケーションでは、レイテンシは数msから数十ms以内に抑える必要がある。

#### パイプライン処理の必要性

前述の厳しい処理時間制約を満たすためには、パイプライン処理が不可欠である。パイプライン処理により、各クロックサイクルで1画素（または複数画素）を処理し、高いスループットを実現できる。

画像処理パイプラインの典型的な構成は以下の通りである：

1. **入力ステージ**：画像データの読み込みとラインバッファへの格納
2. **フィルタリングステージ**：畳み込み演算の実行
3. **後処理ステージ**：正規化、クリッピング、ビット幅調整
4. **出力ステージ**：処理済み画像の出力

各ステージは並行動作し、異なるデータを同時に処理する。これにより、レイテンシは増加するが、スループットは大幅に向上する。

パイプライン設計において重要な点は：

- **バランスの取れたステージ分割**：各ステージの処理時間が均等になるように設計し、ボトルネックを避ける。
- **最小のパイプラインレジスタ**：ステージ間のレジスタは必要最小限に抑え、リソースを節約する。
- **効率的なデータフロー**：メモリアクセスパターンを最適化し、データの流れを滞らせない。

### 3.3 従来手法の課題

前節で述べたハードウェア実装制約を踏まえると、2章で紹介した従来のノイズリダクション手法の多くは、そのままでは実装が困難であることがわかる。本節では、具体的な課題を分析する。

#### 大きなフィルタカーネルの問題

高品質なノイズリダクションを実現するためには、一般的に大きなフィルタカーネルが有効である。しかし、ハードウェア実装においては、フィルタサイズの増大は以下の問題を引き起こす。

##### メモリ使用量の増大

3.1節で述べたように、$K \times K$ のフィルタを実装するには $K$ 行のラインバッファが必要である。例えば、ガウシアンフィルタで十分なノイズ低減効果を得るためには、$\sigma$ を大きくする必要があり、それに応じて有効なフィルタサイズも大きくなる。

ガウス関数 $g(x) = \frac{1}{\sqrt{2\pi\sigma^2}} e^{-\frac{x^2}{2\sigma^2}}$ において、実効的な範囲は約 $\pm 3\sigma$ である。したがって、カーネルサイズは：

$$
K \approx 6\sigma + 1
$$

例えば、$\sigma = 3$ の場合、$K \approx 19$ となり、19行のラインバッファが必要となる。フルHD画像では：

$$
\text{Memory} = 19 \times 1920 \times 8 = 291,840 \text{ bits} \approx 36.5 \text{ KB}
$$

これは、小型の組み込みプロセッサのオンチップRAMを大きく圧迫する。

##### 計算量の増大

$K \times K$ のフィルタでは、1画素あたり $K^2$ 回の乗算が必要である。$K$ が2倍になると計算量は4倍になる：

| フィルタサイズ $K$ | 乗算回数/画素 | フルHD画像の総乗算回数 |
|:---:|:---:|:---:|
| 3 | 9 | 約1,866万回 |
| 5 | 25 | 約5,184万回 |
| 7 | 49 | 約1億160万回 |
| 11 | 121 | 約2億5,091万回 |
| 15 | 225 | 約4億6,656万回 |

大きなフィルタカーネルを用いた場合、要求される演算性能が指数関数的に増大し、リアルタイム処理の実現が困難になる。

##### セパラブルフィルタの限界

ガウシアンフィルタなど一部のフィルタは**セパラブル（分離可能）**であり、2次元畳み込みを水平方向と垂直方向の1次元畳み込みに分解できる：

$$
h[m, n] = h_x[m] \cdot h_y[n]
$$

この場合、計算量は $K^2$ から $2K$ に削減される。しかし、それでも $K$ が大きい場合は大きな計算量となり、また、ラインバッファの必要数は変わらない（垂直方向の畳み込みに $K$ 行必要）。

#### 全画像バッファが必要な手法の不適合性

2章で紹介した手法の中には、画像全体にアクセスする必要があるものがある。

##### 周波数領域フィルタリング

フーリエ変換を用いた周波数領域でのフィルタリングは、理論的に優れた性能を持つが、ハードウェア実装には以下の問題がある：

1. **全画像バッファの必要性**：2次元DFT（離散フーリエ変換）は、画像全体にアクセスする必要があり、フレームバッファが必須となる。
   
2. **FFTの計算量**：$N$ 画素の画像に対する2次元FFTの計算量は $O(N \log N)$ である。フルHD画像では約4200万回の複素数演算が必要となる。

3. **複素数演算の実装コスト**：FFTは複素数演算を多用するため、実数のみで完結する空間フィルタリングと比較して実装コストが高い。

4. **ストリーミング処理との不整合**：FFTは画像全体が揃ってから処理を開始する必要があり、ラインバッファベースのストリーミング処理と相容れない。

##### ウェーブレット変換ベース手法

ウェーブレット変換も画像全体の変換を必要とする場合が多く、同様の問題を抱える。特に、ウェーブレット係数の閾値処理を行う際には、画像全体のウェーブレット係数を保持する必要がある。

#### 複雑なアルゴリズムの実装困難性

2.3節で紹介した適応フィルタリング手法は高性能であるが、アルゴリズムが複雑であり、ハードウェア実装が困難である。

##### バイラテラルフィルタの課題

バイラテラルフィルタは、エッジ保存性能が優れているが、各画素で異なる重み係数を計算する必要がある：

$$
w[i, j] = \exp\left(-\frac{(i-m)^2 + (j-n)^2}{2\sigma_s^2}\right) \cdot \exp\left(-\frac{(I[i,j] - I[m,n])^2}{2\sigma_r^2}\right)
$$

この重み計算には：
- **指数関数の計算**：ハードウェアでの指数関数の実装はルックアップテーブル（LUT）や近似計算が必要。
- **画素値依存の動的計算**：各画素で重みが異なるため、事前計算ができず、リアルタイムで計算する必要がある。
- **正規化処理**：重みの総和で除算する必要があり、除算器も必要。

##### 非局所平均（NLM）の課題

非局所平均（Non-Local Means）は、画像全体から類似パッチを探索するため：

- **広範囲の探索窓**：理論的には画像全体を探索する。実装では探索範囲を制限するが、それでも広範囲のメモリアクセスが必要。
- **パッチ間距離の計算**：各画素で多数のパッチとの類似度を計算する必要があり、膨大な計算量。
- **メモリアクセスパターンの複雑さ**：不規則なメモリアクセスが発生し、キャッシュ効率が悪い。

##### BM3Dの課題

BM3D（Block-Matching and 3D filtering）は最高水準のノイズリダクション性能を持つが：

- **ブロックマッチング**：類似ブロックの探索に膨大な計算量。
- **3次元変換**：類似ブロックを積み重ねて3次元配列とし、3次元変換を適用するため、複雑な処理フロー。
- **メモリ使用量**：中間データの保持に大量のメモリが必要。

これらの手法は、GPUやマルチコアCPUを用いたソフトウェア実装では実用的であるが、FPGAなどのハードウェアへの実装は非現実的である。

#### 実装制約の総括

以上の分析から、既存のノイズリダクション手法をハードウェアに実装する際の主要な障壁は以下の通りである：

1. **メモリ容量の制約により、大きなフィルタカーネルや全画像バッファを必要とする手法は実装困難**。
2. **計算量の制約により、複雑なアルゴリズムや高次の計算を必要とする手法は、リアルタイム処理が困難**。
3. **ストリーミング処理との整合性が取れない手法（全画像アクセスが必要な手法）は、ラインバッファ方式に適合しない**。

これらの制約を克服しつつ、効果的なノイズリダクションを実現するためには、新たなアプローチが必要である。次章では、ハードウェア実装制約を考慮した提案手法を提示する。この手法は、小さなフィルタカーネルと限られたメモリで、効果的なノイズリダクションを実現することを目指す。
